<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Metadaten Cleaner</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- JSZip für Download -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- FileSaver für Download -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <!-- Exif-JS -->
    <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            50: '#f8fafc',
                            100: '#f1f5f9',
                            500: '#64748b',
                            600: '#475569',
                            900: '#0f172a',
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-slate-50 text-slate-800 font-sans min-h-screen flex flex-col justify-center">

    <!-- Kein Header -->

    <!-- Main Content -->
    <main class="flex-grow w-full max-w-5xl mx-auto px-4 py-8 flex flex-col justify-center">
        
        <div class="text-center mb-8">
            <h2 class="text-2xl font-bold text-slate-900 mb-2">Metadaten bereinigen</h2>
            <p class="text-slate-600 text-sm">
                Entfernt Metadaten, reduziert den Header und anonymisiert den Dateinamen.
            </p>
        </div>

        <!-- Drop Zone -->
        <div id="drop-zone" class="border-2 border-dashed border-slate-300 rounded-lg p-12 text-center bg-white transition-all hover:border-slate-500 hover:bg-slate-50 cursor-pointer group relative overflow-hidden shadow-sm">
            <input type="file" id="file-input" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" multiple accept="image/jpeg, image/png, image/webp">
            
            <div class="pointer-events-none transition-transform group-hover:scale-105 duration-300">
                <div class="bg-slate-100 w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-3 text-slate-600">
                    <i class="ph ph-upload-simple text-2xl"></i>
                </div>
                <h3 class="text-lg font-medium text-slate-900">Dateien auswählen</h3>
                <p class="text-slate-400 text-xs mt-1">JPG, PNG, WEBP</p>
            </div>
        </div>

        <!-- File List Area -->
        <div id="file-list-container" class="mt-8 hidden">
            <div class="flex justify-between items-end mb-4">
                <h3 class="text-sm font-semibold text-slate-700 uppercase tracking-wide">
                    Verarbeitete Dateien
                </h3>
                <button id="download-all-btn" class="bg-slate-800 hover:bg-slate-900 text-white px-4 py-2 rounded text-sm font-medium transition-all flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                    <i class="ph ph-download-simple"></i>
                    Alle speichern (ZIP)
                </button>
            </div>

            <div class="bg-white rounded-lg shadow-sm border border-slate-200 overflow-hidden">
                <ul id="file-list" class="divide-y divide-slate-100">
                    <!-- Files injected here -->
                </ul>
            </div>
        </div>

    </main>

    <!-- Minimal Footer -->
    <footer class="py-6 text-center text-slate-400 text-xs">
        <p>Lokale Verarbeitung im Browser.</p>
    </footer>

    <!-- Logic -->
    <script>
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const fileListContainer = document.getElementById('file-list-container');
        const fileList = document.getElementById('file-list');
        const downloadAllBtn = document.getElementById('download-all-btn');

        let processedFiles = []; 
        let isProcessing = false;

        function formatBytes(bytes, decimals = 2) {
            if (!+bytes) return '0 Bytes';
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return `${parseFloat((bytes / Math.pow(k, i)).toFixed(dm))} ${sizes[i]}`;
        }

        // --- Filename Scrambler ---
        function generateScrambledFilename(originalName, typeExtension) {
            const lastDotIndex = originalName.lastIndexOf('.');
            const nameWithoutExt = lastDotIndex !== -1 ? originalName.substring(0, lastDotIndex) : originalName;

            if (nameWithoutExt.length <= 3) {
                return `${nameWithoutExt}_anonym.${typeExtension}`;
            }

            const prefix = nameWithoutExt.substring(0, 3);
            const suffix = nameWithoutExt.substring(3);

            const charArray = suffix.split('');
            for (let i = charArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [charArray[i], charArray[j]] = [charArray[j], charArray[i]];
            }
            
            return `${prefix}${charArray.join('')}.${typeExtension}`;
        }

        function convertDMSToDD(degrees, minutes, seconds, direction) {
            let dd = degrees + minutes/60 + seconds/(60*60);
            if (direction == "S" || direction == "W") dd = dd * -1;
            return dd.toFixed(6);
        }

        // --- BINARY SANITIZERS ---
        async function sanitizeJPEG(blob) {
            const buffer = await blob.arrayBuffer();
            const view = new DataView(buffer);
            let offset = 0;
            const newParts = [];

            if (view.getUint16(0) !== 0xFFD8) return blob; 
            newParts.push(buffer.slice(0, 2)); 
            offset += 2;

            while (offset < view.byteLength) {
                if (view.getUint8(offset) !== 0xFF) { offset++; continue; }
                const marker = view.getUint8(offset + 1);
                
                if (marker === 0x01 || (marker >= 0xD0 && marker <= 0xD7)) { 
                    newParts.push(buffer.slice(offset, offset + 2));
                    offset += 2;
                    continue;
                }
                
                if (marker === 0xD9) { 
                    newParts.push(buffer.slice(offset, offset + 2));
                    break; 
                }

                if (offset + 4 > view.byteLength) break;
                const len = view.getUint16(offset + 2);
                
                const isAppMarker = (marker >= 0xE1 && marker <= 0xEF); 
                const isComment = (marker === 0xFE);

                if (isAppMarker || isComment) {
                    // Strip
                } else if (marker === 0xDA) {
                    newParts.push(buffer.slice(offset)); 
                    break;
                } else {
                    newParts.push(buffer.slice(offset, offset + 2 + len));
                }
                offset += 2 + len;
            }
            return new Blob(newParts, { type: 'image/jpeg' });
        }

        async function sanitizePNG(blob) {
            const buffer = await blob.arrayBuffer();
            const view = new DataView(buffer);
            const signature = [0x89, 0x50, 0x4E, 0x47, 0x0D, 0x0A, 0x1A, 0x0A];
            
            for (let i = 0; i < 8; i++) {
                if (view.getUint8(i) !== signature[i]) return blob; 
            }

            const newParts = [];
            newParts.push(buffer.slice(0, 8)); 
            let offset = 8;

            while (offset < view.byteLength) {
                if (offset + 8 > view.byteLength) break;
                
                const len = view.getUint32(offset);
                const typeCode = view.getUint32(offset + 4);
                const type = String.fromCharCode(
                    (typeCode >> 24) & 0xFF,
                    (typeCode >> 16) & 0xFF,
                    (typeCode >> 8) & 0xFF,
                    typeCode & 0xFF
                );

                const keep = ['IHDR', 'PLTE', 'IDAT', 'IEND', 'tRNS'].includes(type);

                if (keep) {
                    newParts.push(buffer.slice(offset, offset + 12 + len));
                }
                offset += 12 + len;
                if (type === 'IEND') break;
            }
            return new Blob(newParts, { type: 'image/png' });
        }

        // --- STEP 1: Analysis ---
        function analyzeMetadata(file) {
            return new Promise((resolve) => {
                if (file.type !== "image/jpeg" && file.type !== "image/jpg") { resolve([]); return; }
                EXIF.getData(file, function() {
                    const foundTags = [];
                    const allTags = EXIF.getAllTags(this);
                    
                    if (allTags.GPSLatitude && allTags.GPSLongitude) {
                        try {
                            const lat = convertDMSToDD(allTags.GPSLatitude[0], allTags.GPSLatitude[1], allTags.GPSLatitude[2], allTags.GPSLatitudeRef || "N");
                            const lon = convertDMSToDD(allTags.GPSLongitude[0], allTags.GPSLongitude[1], allTags.GPSLongitude[2], allTags.GPSLongitudeRef || "E");
                            foundTags.push({ category: 'GPS', key: 'Standort', value: `${lat}, ${lon}`, icon: 'ph-map-pin', color: 'text-red-600' });
                        } catch(e) {}
                    }
                    if (allTags.Make || allTags.Model) foundTags.push({ category: 'Device', key: 'Kamera', value: `${allTags.Make || ''} ${allTags.Model || ''}`.trim(), icon: 'ph-camera', color: 'text-amber-600' });
                    if (allTags.DateTimeOriginal) foundTags.push({ category: 'Time', key: 'Datum', value: allTags.DateTimeOriginal, icon: 'ph-calendar', color: 'text-amber-600' });
                    if (allTags.Software || allTags.Artist) foundTags.push({ category: 'Auth', key: 'Software/Autor', value: 'Gefunden', icon: 'ph-user', color: 'text-purple-600' });
                    
                    resolve(foundTags);
                });
            });
        }

        // --- STEP 2: Process ---
        async function processImage(file) {
            const removedMetadata = await analyzeMetadata(file);

            return new Promise((resolve, reject) => {
                const img = new Image();
                const url = URL.createObjectURL(file);
                
                img.onload = () => {
                    URL.revokeObjectURL(url);
                    const canvas = document.createElement('canvas');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);
                    
                    const outMime = file.type === 'image/webp' ? 'image/webp' : (file.type === 'image/png' ? 'image/png' : 'image/jpeg');
                    const extension = outMime.split('/')[1];

                    canvas.toBlob(async (blob) => {
                        if (!blob) { reject(new Error('Canvas Error')); return; }

                        let cleanBlob = blob;
                        try {
                            if (outMime === 'image/jpeg') cleanBlob = await sanitizeJPEG(blob);
                            else if (outMime === 'image/png') cleanBlob = await sanitizePNG(blob);
                        } catch (e) {
                            console.error("Sanitization failed", e);
                        }
                        
                        const newFilename = generateScrambledFilename(file.name, extension);

                        resolve({
                            original: file,
                            blob: cleanBlob,
                            name: newFilename,
                            status: 'success',
                            removedData: removedMetadata
                        });

                    }, outMime, 0.95);
                };
                img.onerror = () => reject(new Error('Bildfehler'));
                img.src = url;
            });
        }

        async function handleFiles(files) {
            if (files.length === 0) return;
            fileListContainer.classList.remove('hidden');
            isProcessing = true;
            updateUIState();
            const validFiles = Array.from(files).filter(f => f.type.startsWith('image/'));
            
            const queue = validFiles.map(async (file) => {
                const uiId = Math.random().toString(36).substring(7);
                addFileToUI(file, uiId);
                try {
                    const result = await processImage(file);
                    updateFileUI(uiId, result);
                    processedFiles.push(result);
                } catch (error) {
                    updateFileUI(uiId, { status: 'error', msg: 'Fehler' }, error);
                }
            });
            await Promise.all(queue);
            isProcessing = false;
            updateUIState();
        }

        // --- UI ---
        function addFileToUI(file, id) {
            const li = document.createElement('li');
            li.id = `file-${id}`;
            li.className = 'p-4 border-b border-slate-50 last:border-0 bg-white hover:bg-slate-50 transition-colors';
            
            li.innerHTML = `
                <div class="flex flex-col sm:flex-row gap-4 items-stretch">
                    <!-- Left Column: Input Info + Analysis Report -->
                    <div class="flex-grow min-w-0 py-1">
                        <div class="flex items-center gap-3 mb-2">
                            <div class="w-10 h-10 rounded bg-slate-100 flex items-center justify-center text-slate-400 flex-shrink-0">
                                <i class="ph-fill ph-image text-xl"></i>
                            </div>
                            <div class="min-w-0">
                                <h4 class="text-sm font-bold text-slate-900 truncate" title="${file.name}">${file.name}</h4>
                                <p class="text-xs text-slate-400">${formatBytes(file.size)}</p>
                            </div>
                        </div>
                        
                        <!-- Report Container (Initially Hidden) -->
                        <div class="report-area hidden bg-slate-50 rounded border border-slate-100 p-3 text-xs mt-2"></div>
                    </div>

                    <!-- Right Column: Output Status & Action -->
                    <div class="sm:w-80 flex-shrink-0 sm:border-l sm:border-slate-100 sm:pl-6 flex flex-col justify-center gap-3">
                        
                        <!-- Loading State -->
                        <div class="loading-state flex items-center gap-2 text-slate-500 text-sm h-full justify-center sm:justify-start">
                             <i class="ph ph-spinner animate-spin text-brand-500"></i> Verarbeite...
                        </div>

                        <!-- Result Action Area (Hidden initially) -->
                        <div class="action-area hidden flex-col w-full gap-2">
                             <!-- Status Badge -->
                             <div class="flex justify-between items-center w-full">
                                <span class="text-[10px] uppercase tracking-wider text-slate-400 font-semibold">Status</span>
                                <span class="status-badge text-xs px-2 py-0.5 rounded bg-green-100 text-green-700 font-medium flex items-center gap-1">
                                    <i class="ph-bold ph-check"></i> Bereinigt
                                </span>
                             </div>

                             <!-- Filename + Button Row (Side-by-Side) -->
                             <div class="flex items-stretch gap-2 mt-1">
                                 <!-- New Filename Box (Takes remaining space) -->
                                 <div class="flex-grow min-w-0 bg-slate-50 border border-slate-100 rounded px-2 py-1.5 flex flex-col justify-center">
                                    <span class="text-[10px] text-slate-400 leading-none mb-1">Neuer Name:</span>
                                    <span class="new-filename text-xs font-mono text-slate-600 truncate select-all block leading-none"></span>
                                 </div>
                                 
                                 <!-- Download Button (Right of field) -->
                                 <button onclick="downloadSingle('${id}')" class="flex-shrink-0 bg-slate-800 hover:bg-slate-700 text-white px-3 rounded shadow-sm text-xs font-medium transition-colors flex items-center justify-center min-w-[80px]" title="Speichern">
                                    Speichern
                                </button>
                             </div>
                        </div>
                    </div>
                </div>`;
            fileList.appendChild(li);
        }

        function updateFileUI(id, result, error = null) {
            const el = document.getElementById(`file-${id}`);
            if (!el) return;
            const loadingState = el.querySelector('.loading-state');
            const actionArea = el.querySelector('.action-area');
            const reportArea = el.querySelector('.report-area');
            const newFilenameEl = el.querySelector('.new-filename');

            loadingState.classList.add('hidden');
            
            if (error) {
                reportArea.classList.remove('hidden');
                reportArea.innerHTML = `<span class="text-red-500 font-medium"><i class="ph-bold ph-warning"></i> Fehler bei der Verarbeitung.</span>`;
                return;
            }

            // Update Report (Left Column)
            reportArea.classList.remove('hidden');
            let html = '';
            if (result.removedData && result.removedData.length > 0) {
                html += `
                    <div class="mb-2">
                        <div class="font-semibold text-slate-700 text-xs mb-1.5 border-b border-slate-200 pb-1">Gefundene & entfernte Daten:</div>
                        <div class="flex flex-col gap-1">`;
                result.removedData.forEach(item => {
                    html += `
                        <div class="flex items-start gap-2 text-slate-600">
                            <i class="ph-fill ${item.icon} text-slate-400 mt-0.5 flex-shrink-0"></i>
                            <div class="flex-grow min-w-0">
                                <span class="font-medium text-slate-500 text-[11px] uppercase mr-1">${item.key}:</span>
                                <span class="line-through decoration-red-300 opacity-70 break-words whitespace-normal">${item.value}</span>
                            </div>
                        </div>`;
                });
                html += `</div></div>`;
            } else {
                html += `
                    <div class="mb-2 text-slate-500 italic flex items-center gap-1.5">
                        <i class="ph ph-magnifying-glass text-slate-400"></i>
                        Keine lesbaren Standard-Metadaten gefunden.
                    </div>`;
            }
            html += `
                <div class="pt-2 border-t border-slate-200 text-[10px] font-mono text-slate-500 flex items-center gap-1.5 mt-auto">
                    <i class="ph-bold ph-check text-green-600"></i>
                    <span>Header rekonstruiert & bereinigt.</span>
                </div>`;
            reportArea.innerHTML = html;

            // Update Action Area (Right Column)
            actionArea.classList.remove('hidden');
            actionArea.classList.add('flex');
            newFilenameEl.textContent = result.name;
            
            el.dataset.downloadUrl = URL.createObjectURL(result.blob);
            el.dataset.filename = result.name;
        }

        window.downloadSingle = function(id) { const el = document.getElementById(`file-${id}`); if(el && el.dataset.downloadUrl) saveAs(el.dataset.downloadUrl, el.dataset.filename); };
        function updateUIState() { downloadAllBtn.disabled = isProcessing || processedFiles.length === 0; downloadAllBtn.innerHTML = isProcessing ? `<i class="ph ph-spinner animate-spin"></i>` : `<i class="ph ph-download-simple"></i> Alle (ZIP)`; }

        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('border-slate-500', 'bg-slate-50'); });
        dropZone.addEventListener('dragleave', (e) => { e.preventDefault(); dropZone.classList.remove('border-slate-500', 'bg-slate-50'); });
        dropZone.addEventListener('drop', (e) => { e.preventDefault(); dropZone.classList.remove('border-slate-500', 'bg-slate-50'); handleFiles(e.dataTransfer.files); });
        fileInput.addEventListener('change', (e) => { handleFiles(e.target.files); fileInput.value = ''; });
        downloadAllBtn.addEventListener('click', async () => {
            if (processedFiles.length === 0) return;
            const zip = new JSZip();
            const folder = zip.folder("cleaned_images");
            processedFiles.forEach(f => folder.file(f.name, f.blob));
            const content = await zip.generateAsync({type:"blob"});
            saveAs(content, "clean_images.zip");
        });
    </script>
</body>
</html>



